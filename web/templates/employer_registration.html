{% extends 'base.html' %}

{% block title %}Employer Registration - SuitableSkills{% endblock %}

{% block content %}
<div class="registration-container">
    <div class="header">
        <h1>Employer Registration</h1>
        <p>Connect with talented students for your projects</p>
        <div class="ai-status">
            <div class="ai-indicator"></div>
            <span>AI-Assisted Verification</span>
        </div>
    </div>

    <div class="form-container">
        <!-- Step Indicator -->
        <div class="step-indicator" id="stepIndicator">
            <div class="step" data-step="0">
                <div class="step-number active" id="step0">1</div>
                <div class="step-title active">Company Scan</div>
            </div>
            <div class="step" data-step="1">
                <div class="step-number" id="step1">2</div>
                <div class="step-title">Company Info</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number" id="step2">3</div>
                <div class="step-title">Account & Contact</div>
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Registration Form -->
        <form id="employerRegistrationForm">
            {% csrf_token %}
            <input type="hidden" name="current_step" id="currentStep" value="0">
            
            <div id="formContent">
                <!-- Step 0: Company Webpage Scan -->
                <div class="step-content" id="stepContent0">
                    <h3 class="mb-4">Speed Up Registration <span class="text-muted">(Optional)</span></h3>
                    <div class="resume-upload" onclick="document.getElementById('webpageUrl').focus()">
                        <div class="upload-icon">üåê</div>
                        <h4>Scan your company website <small class="text-muted">(Optional)</small></h4>
                        <p>Enter your company website URL to automatically fill in company details</p>
                        <small class="text-muted">You can skip this step and fill out your information manually</small>
                    </div>
                    
                    <div class="mt-3">
                        <label for="webpageUrl" class="form-label">Company Website URL</label>
                        <div class="input-group">
                            <input type="url" class="form-control" id="webpageUrl" name="webpage_url" 
                                   placeholder="https://www.yourcompany.com">
                            <button type="button" class="btn btn-primary" onclick="scanWebpage()">
                                <i class="bi bi-search"></i> Scan Website
                            </button>
                        </div>
                        <div class="form-text">Try: "https://techcorp.com", "https://creative-agency.com", or "https://healthcare.com"</div>
                    </div>
                    
                    <div class="progress-container" id="webpageProgressContainer">
                        <p>Scanning website and extracting company information...</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="webpageProgressFill"></div>
                        </div>
                        <p id="webpageProgressText">0%</p>
                    </div>
                </div>

                <!-- Step 1: Company Information -->
                <div class="step-content d-none" id="stepContent1">
                    <h3 class="mb-4">Company Information</h3>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="companyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" name="company_name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="industry" class="form-label">Industry</label>
                            <select class="form-select" id="industry" name="industry" required>
                                <option value="">Select industry</option>
                                <option value="technology">Technology</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="finance">Finance</option>
                                <option value="education">Education</option>
                                <option value="retail">Retail</option>
                                <option value="manufacturing">Manufacturing</option>
                                <option value="consulting">Consulting</option>
                                <option value="non-profit">Non-Profit</option>
                                <option value="government">Government</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="website" class="form-label">Company Website</label>
                            <input type="url" class="form-control" id="website" name="website" placeholder="https://www.company.com">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyLocation" class="form-label">Company Location</label>
                            <input type="text" class="form-control" id="companyLocation" name="company_location" placeholder="St. John's, NL" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="companyDescription" class="form-label">Company Description</label>
                        <textarea class="form-control" id="companyDescription" name="company_description" rows="4" 
                                  placeholder="Describe your company, what you do, and your mission..." required></textarea>
                        <div class="form-text">This helps students understand your organization</div>
                    </div>
                </div>

                <!-- Step 2: Account & Contact Information -->
                <div class="step-content d-none" id="stepContent2">
                    <h3 class="mb-4">Account & Contact Information</h3>
                    <div class="alert alert-info">
                        <strong>Note:</strong> You will be the primary contact for student communications and project coordination.
                    </div>
                    
                    <!-- Account Setup -->
                    <h5 class="mb-3">Account Setup</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="last_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Business Email</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="your.email@company.com" required>
                            <div class="form-text">Use your company email address</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" name="phone" placeholder="(709) 123-4567">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required minlength="8">
                            <div class="form-text">Must be at least 8 characters long</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Contact Details -->
                    <h5 class="mb-3">Contact Information</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contactTitle" class="form-label">Your Job Title</label>
                            <input type="text" class="form-control" id="contactTitle" name="contact_title" 
                                   placeholder="e.g., Project Manager, HR Director" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contactPhone" class="form-label">Additional Contact Phone</label>
                            <input type="tel" class="form-control" id="contactPhone" name="contact_phone" placeholder="(709) 123-4567">
                            <div class="form-text">Optional - if different from above</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Project Types You're Interested In</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="project_types" value="web_development" id="webDev">
                                    <label class="form-check-label" for="webDev">Web Development</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="project_types" value="mobile_app" id="mobileApp">
                                    <label class="form-check-label" for="mobileApp">Mobile Apps</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="project_types" value="data_analysis" id="dataAnalysis">
                                    <label class="form-check-label" for="dataAnalysis">Data Analysis</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="project_types" value="research" id="research">
                                    <label class="form-check-label" for="research">Research</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="project_types" value="design" id="design">
                                    <label class="form-check-label" for="design">Design</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="project_types" value="marketing" id="marketing">
                                    <label class="form-check-label" for="marketing">Marketing</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="project_types" value="consulting" id="consulting">
                                    <label class="form-check-label" for="consulting">Consulting</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="project_types" value="writing" id="writing">
                                    <label class="form-check-label" for="writing">Content Writing</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="project_types" value="other" id="other">
                                    <label class="form-check-label" for="other">Other</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">‚Üê Previous</button>
                <div class="ms-auto">
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">Continue ‚Üí</button>
                    <button type="button" class="btn btn-primary d-none" id="submitBtn" onclick="submitForm()">Submit for Review</button>
                </div>
            </div>
        </form>
        
        <div class="text-center mt-4">
            <p class="text-muted">Already have an account? <a href="{% url 'web:login' %}">Sign in here</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 0;
const totalSteps = 2;

// Step navigation
function nextStep() {
    if (currentStep < totalSteps) {
        // Hide current step
        document.getElementById(`stepContent${currentStep}`).classList.add('d-none');
        updateStepIndicator(currentStep, 'completed');
        
        // Show next step
        currentStep++;
        document.getElementById(`stepContent${currentStep}`).classList.remove('d-none');
        updateStepIndicator(currentStep, 'active');
        
        // Update navigation buttons
        updateNavigationButtons();
        
        // Update hidden field
        document.getElementById('currentStep').value = currentStep;
    }
}

function previousStep() {
    if (currentStep > 0) {
        // Hide current step
        document.getElementById(`stepContent${currentStep}`).classList.add('d-none');
        updateStepIndicator(currentStep, '');
        
        // Show previous step
        currentStep--;
        document.getElementById(`stepContent${currentStep}`).classList.remove('d-none');
        updateStepIndicator(currentStep, 'active');
        
        // Update navigation buttons
        updateNavigationButtons();
        
        // Update hidden field
        document.getElementById('currentStep').value = currentStep;
    }
}

function updateStepIndicator(step, status) {
    const stepNumber = document.getElementById(`step${step}`);
    const stepTitle = stepNumber.parentElement.querySelector('.step-title');
    
    // Reset classes
    stepNumber.className = 'step-number';
    stepTitle.className = 'step-title';
    
    // Apply new status
    if (status) {
        stepNumber.classList.add(status);
        stepTitle.classList.add(status);
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    // Show/hide previous button
    prevBtn.style.display = currentStep > 0 ? 'block' : 'none';
    
    // Update next button text and show/hide submit button
    if (currentStep === totalSteps) {
        nextBtn.classList.add('d-none');
        submitBtn.classList.remove('d-none');
    } else {
        nextBtn.classList.remove('d-none');
        submitBtn.classList.add('d-none');
    }
}


// Form submission
function submitForm() {
    // Validate passwords match
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (password !== confirmPassword) {
        alert('Passwords do not match. Please check your password fields.');
        currentStep = 2;
        showStep(2);
        return;
    }
    
    if (password.length < 8) {
        alert('Password must be at least 8 characters long.');
        currentStep = 2;
        showStep(2);
        return;
    }
    
    const form = document.getElementById('employerRegistrationForm');
    const formData = new FormData(form);
    
    // Set contact name to be the same as the user (since they are the contact person)
    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    formData.set('contact_name', `${firstName} ${lastName}`);
    
    // Set final step
    formData.set('current_step', '2');
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;
    
    fetch('{% url "web:process_employer_registration" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update button to show completion
            submitBtn.textContent = 'Done';
            
            // Show success message
            document.getElementById('formContent').innerHTML = `
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="display-1 text-success">‚úÖ</i>
                    </div>
                    <h3 class="text-success mb-3">Registration Submitted!</h3>
                    <p class="mb-4">${data.message || 'Your registration has been submitted for review.'}</p>
                    <div class="alert alert-info">
                        <h6>What happens next?</h6>
                        <ul class="text-start mb-0">
                            <li>Our admin team will review your application within 24-48 hours</li>
                            <li>You'll receive an email notification once approved</li>
                            <li>After approval, you can sign in and start posting projects</li>
                        </ul>
                    </div>
                    <a href="{% url 'web:home' %}" class="btn btn-primary">Return to Home</a>
                </div>
            `;
            
            // Hide navigation buttons
            document.querySelector('.d-flex.justify-content-between').style.display = 'none';
        } else {
            alert('Error: ' + data.message);
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting your registration. Please try again.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

function showStep(step) {
    // Hide all steps (including step 0)
    for (let i = 0; i <= totalSteps; i++) {
        document.getElementById(`stepContent${i}`).classList.add('d-none');
        updateStepIndicator(i, '');
    }
    
    // Show target step
    document.getElementById(`stepContent${step}`).classList.remove('d-none');
    updateStepIndicator(step, 'active');
    currentStep = step;
    updateNavigationButtons();
}

// Webpage scanning functionality
function scanWebpage() {
    const urlInput = document.getElementById('webpageUrl');
    const url = urlInput.value.trim();
    
    if (!url) {
        alert('Please enter a website URL');
        return;
    }
    
    simulateWebpageScan(url);
}

function simulateWebpageScan(url) {
    const progressContainer = document.getElementById('webpageProgressContainer');
    const progressFill = document.getElementById('webpageProgressFill');
    const progressText = document.getElementById('webpageProgressText');
    
    progressContainer.style.display = 'block';
    
    // Reset progress bar to 0
    progressFill.style.width = '0%';
    progressText.textContent = '0%';
    
    let progress = 0;
    const stages = [
        'Connecting to website...',
        'Analyzing page content...',
        'Extracting company information...',
        'Processing business details...',
        'Finalizing data extraction...'
    ];
    
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        
        progressFill.style.width = progress + '%';
        const stageIndex = Math.floor((progress / 100) * stages.length);
        progressText.textContent = stages[Math.min(stageIndex, stages.length - 1)];
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                // Call the API to extract data
                extractWebpageData(url);
            }, 500);
        }
    }, 300);
}

function extractWebpageData(url) {
    fetch('/api/content/scan-webpage/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            webpage_url: url,
            csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            populateFromWebpage(data.extracted_data);
            document.getElementById('webpageProgressContainer').style.display = 'none';
            // Auto-advance to next step after delay
            setTimeout(() => {
                nextStep();
            }, 1000);
        } else {
            alert('Error scanning webpage: ' + data.message);
            document.getElementById('webpageProgressContainer').style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while scanning the webpage. Please try again.');
        document.getElementById('webpageProgressContainer').style.display = 'none';
    });
}

function populateFromWebpage(data) {
    // Populate company information in step 2
    if (data.company_name) {
        document.getElementById('companyName').value = data.company_name;
    }
    if (data.industry) {
        document.getElementById('industry').value = data.industry;
    }
    if (data.website) {
        document.getElementById('website').value = data.website;
    }
    if (data.company_location) {
        document.getElementById('companyLocation').value = data.company_location;
    }
    if (data.company_description) {
        document.getElementById('companyDescription').value = data.company_description;
    }
    
    // Show success feedback
    const scanContainer = document.querySelector('#stepContent0 .resume-upload');
    scanContainer.innerHTML = `
        <div class="upload-icon">‚úÖ</div>
        <h4 class="text-success">Website Scanned Successfully!</h4>
        <p>Company information has been extracted and will be pre-filled in the next steps.</p>
        <small class="text-muted">You can review and modify the information as needed.</small>
    `;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateNavigationButtons();
    
    // Add field monitoring for AI validation
    document.querySelectorAll('input, select, textarea').forEach(field => {
        field.addEventListener('input', function() {
            analyzeField(this);
        });
    });
    
    // Add Enter key support for webpage URL
    document.getElementById('webpageUrl').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            scanWebpage();
        }
    });
    
    // Demo mode key combination (Ctrl+Shift+D) - fills step 2 (Account & Contact)
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            fillDemoAccountContact();
        }
    });
});

// Demo mode function
function fillDemoAccountContact() {
    // If on step 0 (Company Scan), fill webpage URL
    if (currentStep === 0) {
        document.getElementById('webpageUrl').value = 'https://techcorp.com';
        return;
    }
    
    // If on step 2 (Account & Contact), fill all fields
    if (currentStep === 2) {
        // Fill account setup fields
        document.getElementById('firstName').value = 'Sarah';
        document.getElementById('lastName').value = 'Johnson';
        document.getElementById('email').value = 'sarah.johnson@techcorp.com';
        document.getElementById('phone').value = '(709) 555-0123';
        document.getElementById('password').value = 'demo1234';
        document.getElementById('confirmPassword').value = 'demo1234';
        
        // Fill contact information
        document.getElementById('contactTitle').value = 'Project Manager';
        document.getElementById('contactPhone').value = '(709) 555-0124';
        
        // Select some project types
        document.getElementById('webDev').checked = true;
        document.getElementById('mobileApp').checked = true;
        document.getElementById('dataAnalysis').checked = true;
    }
}
</script>
{% endblock %}