{% extends 'base.html' %}

{% block title %}Student Registration - SuitableSkills{% endblock %}

{% block content %}
<div class="registration-container">
    <div class="header">
        <h1>Student Profile</h1>
        <p>Create your profile with AI assistance</p>
        <div class="ai-status">
            <div class="ai-indicator"></div>
            <span>AI Assistant Active</span>
        </div>
    </div>

    <div class="form-container">
        <!-- Step Indicator -->
        <div class="step-indicator" id="stepIndicator">
            <div class="step" data-step="1">
                <div class="step-number active" id="step1">1</div>
                <div class="step-title active">Resume Upload</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number" id="step2">2</div>
                <div class="step-title">Basic Info</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number" id="step3">3</div>
                <div class="step-title">Education</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number" id="step4">4</div>
                <div class="step-title">Employment</div>
            </div>
            <div class="step" data-step="5">
                <div class="step-number" id="step5">5</div>
                <div class="step-title">Skills</div>
            </div>
            <div class="step" data-step="6">
                <div class="step-number" id="step6">6</div>
                <div class="step-title">Availability</div>
            </div>
            <div class="step" data-step="7">
                <div class="step-number" id="step7">7</div>
                <div class="step-title">Preferences</div>
            </div>
            <div class="step" data-step="8">
                <div class="step-number" id="step8">8</div>
                <div class="step-title">Documents & Links</div>
            </div>
        </div>

        <!-- Registration Form -->
        <form id="registrationForm">
            {% csrf_token %}
            <input type="hidden" name="current_step" id="currentStep" value="1">
            
            <div id="formContent">
                <!-- Step 1: Resume Upload & Profile Import -->
                <div class="step-content" id="stepContent1">
                    <h3 class="mb-4">Speed Up Your Profile <span class="text-muted">(Optional)</span></h3>
                    <p class="text-muted mb-4">Import information from your resume or online profiles to pre-fill your registration. Both options are optional and independent.</p>
                    
                    <!-- Resume Upload Section -->
                    <div class="mb-4">
                        <div class="resume-upload" onclick="document.getElementById('resumeFile').click()">
                            <div class="upload-icon">üìÑ</div>
                            <h4>Upload Resume <small class="text-muted">(Optional)</small></h4>
                            <p>Click to browse or drag and drop your resume (PDF, DOC, DOCX, TXT, MD, HTML)</p>
                            <small class="text-muted">Upload your resume to auto-fill education, employment, and skills</small>
                            <input type="file" id="resumeFile" accept=".pdf,.doc,.docx,.txt,.md,.html" style="display: none;">
                        </div>
                        <div class="progress-container" id="resumeProgressContainer">
                            <p>Analyzing resume...</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="resumeProgressFill"></div>
                            </div>
                            <p id="resumeProgressText">0%</p>
                        </div>
                        <div id="resumeSuccess" class="alert alert-success mt-2" style="display: none;">
                            ‚úÖ Resume uploaded successfully! Information has been extracted and will be pre-filled in the following steps.
                        </div>
                    </div>
                    
                    <!-- Webpage/Profile Scan Section -->
                    <div class="mb-4">
                        <div class="resume-upload">
                            <div class="upload-icon">üåê</div>
                            <h4>Import from Online Profile <small class="text-muted">(Optional)</small></h4>
                            <p>Scan your LinkedIn, GitHub, or portfolio website to import profile information</p>
                            <div class="mt-3">
                                <label for="profileWebpageUrl" class="form-label">Profile URL</label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="profileWebpageUrl" name="profile_webpage_url" 
                                           placeholder="https://linkedin.com/in/yourname or https://github.com/username">
                                    <button type="button" class="btn btn-primary" onclick="scanStudentWebpage()">
                                        <i class="bi bi-search"></i> Import Profile
                                    </button>
                                </div>
                                <div class="form-text">Try: "https://linkedin.com/in/sarah-chen", "https://github.com/developer", or "https://myportfolio.com"</div>
                            </div>
                        </div>
                        
                        <div class="progress-container" id="webpageProfileProgressContainer">
                            <p>Scanning profile and extracting information...</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="webpageProfileProgressFill"></div>
                            </div>
                            <p id="webpageProfileProgressText">0%</p>
                        </div>
                        <div id="webpageSuccess" class="alert alert-success mt-2" style="display: none;">
                            ‚úÖ Profile imported successfully! Information has been extracted and will be pre-filled in the following steps.
                        </div>
                    </div>
                    
                    <!-- Continue Button -->
                    <div class="text-center">
                        <p class="text-muted mb-3">You can also skip both options and fill out your profile manually</p>
                    </div>
                </div>

                <!-- Step 2: Basic Information -->
                <div class="step-content d-none" id="stepContent2">
                    <h3 class="mb-4">Basic Information</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="last_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="your.email@mun.ca" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" name="phone" placeholder="(709) 123-4567">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="academicYear" class="form-label">Academic Year</label>
                            <select class="form-select" id="academicYear" name="academic_year" required>
                                <option value="">Select year</option>
                                <option value="freshman">Freshman</option>
                                <option value="sophomore">Sophomore</option>
                                <option value="junior">Junior</option>
                                <option value="senior">Senior</option>
                                <option value="graduate">Graduate</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="program" class="form-label">Program/Major</label>
                            <input type="text" class="form-control" id="program" name="program" placeholder="e.g., Computer Science, Engineering, Business" required>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Education History -->
                <div class="step-content d-none" id="stepContent3">
                    <h3 class="mb-4">Education History</h3>
                    <div id="educationContainer">
                        <div class="education-item border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Institution</label>
                                    <input type="text" class="form-control" name="education_institution_0" placeholder="Memorial University of Newfoundland">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Degree/Program</label>
                                    <input type="text" class="form-control" name="education_degree_0" placeholder="Bachelor of Science">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Field of Study</label>
                                    <input type="text" class="form-control" name="education_field_0" placeholder="Computer Science">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">GPA (Optional)</label>
                                    <input type="number" class="form-control" name="education_gpa_0" step="0.01" min="0" max="4">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" name="education_start_0">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" name="education_end_0">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="education_current_0" id="educationCurrent0">
                                    <label class="form-check-label" for="educationCurrent0">Currently enrolled</label>
                                </div>
                                <button type="button" class="remove-entry" onclick="removeEducation(this)" title="Remove education entry"><i class="bi bi-trash3"></i></button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary" onclick="addEducation()">+ Add Education</button>
                </div>

                <!-- Step 4: Employment History -->
                <div class="step-content d-none" id="stepContent4">
                    <h3 class="mb-4">Employment History</h3>
                    <div id="employmentContainer">
                        <div class="employment-item border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Company/Organization</label>
                                    <input type="text" class="form-control" name="employment_company_0" placeholder="Company name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Position Title</label>
                                    <input type="text" class="form-control" name="employment_position_0" placeholder="Job title">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" name="employment_start_0">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" name="employment_end_0">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="employment_description_0" rows="3" placeholder="Describe your responsibilities and achievements..."></textarea>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="employment_current_0" id="employmentCurrent0">
                                    <label class="form-check-label" for="employmentCurrent0">Currently employed</label>
                                </div>
                                <button type="button" class="remove-entry" onclick="removeEmployment(this)" title="Remove employment entry"><i class="bi bi-trash3"></i></button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary" onclick="addEmployment()">+ Add Employment</button>
                </div>

                <!-- Step 5: Skills & Experience -->
                <div class="step-content d-none" id="stepContent5">
                    <h3 class="mb-4">Skills & Experience</h3>
                    <div id="skillsContainer">
                        <div class="skill-experience-item border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Skill Name</label>
                                    <input type="text" class="form-control" name="skill_name_0" placeholder="e.g., Python, JavaScript, Project Management">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Level</label>
                                    <select class="form-select" name="skill_level_0">
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                        <option value="expert">Expert</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-start justify-content-end pt-2">
                                    <button type="button" class="remove-entry" onclick="removeSkill(this)" title="Remove skill entry"><i class="bi bi-trash3"></i></button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Experience Description</label>
                                <textarea class="form-control" name="skill_description_0" rows="2" placeholder="Describe your experience with this skill... (Try: 'Python web development', 'JavaScript', or 'database')"></textarea>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary mb-3" onclick="addSkill()">+ Add More Skills and Experience</button>
                    
                    <!-- AI Analysis Progress -->
                    <div class="ai-analysis-progress" id="aiAnalysisProgress">
                        <div class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>AI is analyzing your skills...</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="aiProgressBar"></div>
                        </div>
                        <small class="text-muted mt-1" id="aiProgressText">Initializing analysis...</small>
                    </div>
                </div>

                <!-- Step 6: Availability -->
                <div class="step-content d-none" id="stepContent6">
                    <h3 class="mb-4">Availability</h3>
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="availability" value="weekends" id="weekends">
                                <label class="form-check-label" for="weekends">Weekends</label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="availability" value="evenings" id="evenings">
                                <label class="form-check-label" for="evenings">Evenings</label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="availability" value="summer" id="summer">
                                <label class="form-check-label" for="summer">Summer Break</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="availability" value="parttime" id="parttime">
                                <label class="form-check-label" for="parttime">Part-time during semester</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="availability" value="coop" id="coop">
                                <label class="form-check-label" for="coop">Full-time co-op</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="currentlyAvailable" class="form-label">Currently Available</label>
                            <select class="form-select" id="currentlyAvailable" name="currently_available">
                                <option value="">Select status</option>
                                <option value="yes">Yes, immediately</option>
                                <option value="no">No, not currently</option>
                                <option value="limited">Limited availability</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="availableDate" class="form-label">Available as of Date</label>
                            <input type="date" class="form-control" id="availableDate" name="available_date">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="availabilityNotes" class="form-label">Availability Notes</label>
                        <textarea class="form-control" id="availabilityNotes" name="availability_notes" rows="3" placeholder="Any additional details about your availability..."></textarea>
                    </div>
                </div>

                <!-- Step 7: Work Preferences -->
                <div class="step-content d-none" id="stepContent7">
                    <h3 class="mb-4">Work Preferences</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="remotePreference" class="form-label">Remote Work Preference</label>
                            <select class="form-select" id="remotePreference" name="remote_preference">
                                <option value="">Select preference</option>
                                <option value="remote">Fully remote</option>
                                <option value="hybrid">Hybrid (remote + in-person)</option>
                                <option value="onsite">On-site only</option>
                                <option value="flexible">Flexible</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="locationFlexibility" class="form-label">Location Flexibility</label>
                            <select class="form-select" id="locationFlexibility" name="location_flexibility">
                                <option value="">Select flexibility</option>
                                <option value="local">Local area only</option>
                                <option value="regional">Regional (within province)</option>
                                <option value="national">National</option>
                                <option value="international">International</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="careerGoals" class="form-label">Career Goals</label>
                        <textarea class="form-control" id="careerGoals" name="career_goals" rows="3" placeholder="Describe your career goals and aspirations..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="additionalInfo" class="form-label">Additional Information</label>
                        <textarea class="form-control" id="additionalInfo" name="additional_info" rows="3" placeholder="Any other information you'd like to share..."></textarea>
                    </div>
                    
                </div>

                <!-- Step 8: Documents & Links -->
                <div class="step-content d-none" id="stepContent8">
                    <h3 class="mb-4">Documents & Links</h3>
                    <p class="text-muted mb-4">Add supporting documents and external links to showcase your background and work.</p>
                    
                    <!-- Documents Section -->
                    <div class="mb-4">
                        <h5 class="mb-3">üìÑ Documents</h5>
                        <div id="documentsContainer">
                            <div class="document-item border rounded p-3 mb-3">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Document Type</label>
                                        <select class="form-select" name="document_type_0">
                                            <option value="">Select type</option>
                                            <option value="resume">Resume/CV</option>
                                            <option value="transcript">Transcript</option>
                                            <option value="portfolio">Portfolio</option>
                                            <option value="certificate">Certificate</option>
                                            <option value="reference">Reference Letter</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Document Title</label>
                                        <input type="text" class="form-control" name="document_title_0" placeholder="e.g., My Resume 2024">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Upload File</label>
                                        <input type="file" class="form-control" name="document_file_0" accept=".pdf,.doc,.docx,.txt,.md,.html">
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end justify-content-center pb-3">
                                        <button type="button" class="remove-entry" onclick="removeDocument(this)" title="Remove document"><i class="bi bi-trash3"></i></button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description <small class="text-muted">(Optional)</small></label>
                                    <textarea class="form-control" name="document_description_0" rows="2" placeholder="Brief description of this document..."></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary" onclick="addDocument()">+ Add Document</button>
                    </div>

                    <!-- External Links Section -->
                    <div class="mb-4">
                        <h5 class="mb-3">üîó External Links & Profiles</h5>
                        <div id="linksContainer">
                            <div class="link-item border rounded p-3 mb-3">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Link Type</label>
                                        <select class="form-select" name="link_type_0">
                                            <option value="">Select type</option>
                                            <option value="linkedin">LinkedIn Profile</option>
                                            <option value="github">GitHub Profile</option>
                                            <option value="portfolio">Portfolio Website</option>
                                            <option value="blog">Blog/Personal Site</option>
                                            <option value="behance">Behance Portfolio</option>
                                            <option value="dribbble">Dribbble Portfolio</option>
                                            <option value="twitter">Twitter/X Profile</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Link Title</label>
                                        <input type="text" class="form-control" name="link_title_0" placeholder="e.g., My LinkedIn Profile">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">URL</label>
                                        <input type="url" class="form-control" name="link_url_0" placeholder="https://...">
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end justify-content-center pb-3">
                                        <button type="button" class="remove-entry" onclick="removeLink(this)" title="Remove link"><i class="bi bi-trash3"></i></button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description <small class="text-muted">(Optional)</small></label>
                                    <textarea class="form-control" name="link_description_0" rows="2" placeholder="Brief description of this link..."></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary" onclick="addLink()">+ Add Link</button>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">‚Üê Previous</button>
                <div class="ms-auto">
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">Continue ‚Üí</button>
                    <button type="button" class="btn btn-primary d-none" id="submitBtn" onclick="submitForm()">Create Profile</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
const totalSteps = 8;
let educationCount = 1;
let employmentCount = 1;
let skillCount = 1;
let documentCount = 1;
let linkCount = 1;
let skillsAnalyzed = false;  // Track if skills have been analyzed
let originalSkillDescriptions = new Map();  // Track original skill description values

// Step navigation
function nextStep() {
    if (currentStep === 5) {
        // Check if skill descriptions have changed since last analysis
        if (skillsAnalyzed && !haveSkillDescriptionsChanged()) {
            // No changes, proceed directly to next step
            proceedToNextStep();
            return;
        }
        
        // AI analysis before moving to availability
        reviewSkillsWithAI();
        return;
    }
    
    if (currentStep < totalSteps) {
        // Hide current step
        document.getElementById(`stepContent${currentStep}`).classList.add('d-none');
        updateStepIndicator(currentStep, 'completed');
        
        // Show next step
        currentStep++;
        document.getElementById(`stepContent${currentStep}`).classList.remove('d-none');
        updateStepIndicator(currentStep, 'active');
        
        // If entering skills step for first time, capture original descriptions
        if (currentStep === 5 && originalSkillDescriptions.size === 0) {
            setTimeout(() => captureOriginalSkillDescriptions(), 100);
        }
        
        // If entering documents & links step, pre-populate from scanning
        if (currentStep === 8) {
            setTimeout(() => populateDocumentsAndLinksFromScanning(), 100);
        }
        
        // Update navigation buttons
        updateNavigationButtons();
        
        // Update hidden field
        document.getElementById('currentStep').value = currentStep;
    }
}

function previousStep() {
    if (currentStep > 1) {
        // Hide current step
        document.getElementById(`stepContent${currentStep}`).classList.add('d-none');
        updateStepIndicator(currentStep, '');
        
        // Show previous step
        currentStep--;
        document.getElementById(`stepContent${currentStep}`).classList.remove('d-none');
        updateStepIndicator(currentStep, 'active');
        
        // Update navigation buttons
        updateNavigationButtons();
        
        // Update hidden field
        document.getElementById('currentStep').value = currentStep;
    }
}

function updateStepIndicator(step, status) {
    const stepNumber = document.getElementById(`step${step}`);
    const stepTitle = stepNumber.parentElement.querySelector('.step-title');
    
    // Reset classes
    stepNumber.className = 'step-number';
    stepTitle.className = 'step-title';
    
    // Apply new status
    if (status) {
        stepNumber.classList.add(status);
        stepTitle.classList.add(status);
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    // Show/hide previous button
    prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
    
    // Show/hide next/submit buttons
    if (currentStep === totalSteps) {
        nextBtn.classList.add('d-none');
        submitBtn.classList.remove('d-none');
    } else {
        nextBtn.classList.remove('d-none');
        submitBtn.classList.add('d-none');
    }
}

function proceedToNextStep() {
    // Hide current step
    document.getElementById(`stepContent${currentStep}`).classList.add('d-none');
    updateStepIndicator(currentStep, 'completed');
    
    // Show next step
    currentStep++;
    document.getElementById(`stepContent${currentStep}`).classList.remove('d-none');
    updateStepIndicator(currentStep, 'active');
    
    // Update navigation buttons
    updateNavigationButtons();
    
    // Update hidden field
    document.getElementById('currentStep').value = currentStep;
}

function captureOriginalSkillDescriptions() {
    const skillDescInputs = document.querySelectorAll('textarea[name^="skill_description_"]');
    skillDescInputs.forEach(input => {
        if (input.name) {
            originalSkillDescriptions.set(input.name, input.value.trim());
        }
    });
}

function haveSkillDescriptionsChanged() {
    const skillDescInputs = document.querySelectorAll('textarea[name^="skill_description_"]');
    
    for (let input of skillDescInputs) {
        if (input.name) {
            const currentValue = input.value.trim();
            const originalValue = originalSkillDescriptions.get(input.name) || '';
            if (currentValue !== originalValue) {
                return true;
            }
        }
    }
    return false;
}

// AI Skills Review
function reviewSkillsWithAI() {
    const nextBtn = document.getElementById('nextBtn');
    const originalText = nextBtn.textContent;
    
    nextBtn.textContent = 'Analyzing...';
    nextBtn.disabled = true;
    
    showAIAnalysisProgress();
    
    // Reset progress bar to 0
    const progressBar = document.getElementById('aiProgressBar');
    const progressText = document.getElementById('aiProgressText');
    progressBar.style.width = '0%';
    progressText.textContent = 'Initializing analysis...';
    
    // Simulate AI analysis with progress
    let progress = 0;
    
    const stages = [
        'Analyzing skill combinations...',
        'Checking market demand...',
        'Validating experience levels...',
        'Generating recommendations...',
        'Finalizing analysis...'
    ];
    
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        
        progressBar.style.width = progress + '%';
        const stageIndex = Math.floor((progress / 100) * stages.length);
        progressText.textContent = stages[Math.min(stageIndex, stages.length - 1)];
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                hideAIAnalysisProgress();
                generateSkillAnnotations();
                
                // Mark as analyzed and capture current state
                skillsAnalyzed = true;
                captureOriginalSkillDescriptions();
                
                nextBtn.textContent = 'Continue ‚Üí';
                nextBtn.disabled = false;
                
                // Don't auto-proceed - let user click continue manually
                // This prevents the loop issue
            }, 500);
        }
    }, 200);
}

function showAIAnalysisProgress() {
    document.getElementById('aiAnalysisProgress').style.display = 'block';
}

function hideAIAnalysisProgress() {
    document.getElementById('aiAnalysisProgress').style.display = 'none';
}

function generateSkillAnnotations() {
    const skillItems = document.querySelectorAll('.skill-experience-item');
    let hasAnnotations = false;
    
    // Use exact matches for the trigger phrases
    skillItems.forEach((item, index) => {
        const skillNameInput = item.querySelector('input[name^="skill_name_"]');
        const skillDescInput = item.querySelector('textarea[name^="skill_description_"]');
        
        if (skillDescInput && skillDescInput.value) {
            const value = skillDescInput.value.toLowerCase().trim();
            if (value === 'python web development') {
                showAnnotation(skillDescInput, 'What specific Python frameworks have you used? Django, Flask, FastAPI?', 'info');
                hasAnnotations = true;
            } else if (value === 'javascript') {
                showAnnotation(skillDescInput, 'Have you worked with React, Vue, or Node.js? Consider mentioning specific projects.', 'info');
                hasAnnotations = true;
            } else if (value === 'database') {
                showAnnotation(skillDescInput, 'Which database systems? SQL (MySQL, PostgreSQL) or NoSQL (MongoDB, Redis)?', 'info');
                hasAnnotations = true;
            }
        }
    });
    
    // If no annotations were shown, proceed to next step automatically
    if (!hasAnnotations) {
        setTimeout(() => {
            proceedToNextStep();
        }, 100);
    }
}

// Dynamic form management
function addEducation() {
    const container = document.getElementById('educationContainer');
    const newItem = container.children[0].cloneNode(true);
    
    // Update field names and IDs
    const inputs = newItem.querySelectorAll('input');
    inputs.forEach(input => {
        const name = input.name.replace(/_\d+$/, `_${educationCount}`);
        input.name = name;
        input.value = '';
        if (input.id) {
            input.id = input.id.replace(/\d+$/, educationCount);
        }
    });
    
    // Update checkbox label
    const checkbox = newItem.querySelector('.form-check-input');
    const label = newItem.querySelector('.form-check-label');
    if (checkbox && label) {
        checkbox.id = `educationCurrent${educationCount}`;
        label.setAttribute('for', `educationCurrent${educationCount}`);
    }
    
    container.appendChild(newItem);
    educationCount++;
}

function removeEducation(button) {
    const container = document.getElementById('educationContainer');
    if (container.children.length > 1) {
        button.closest('.education-item').remove();
    }
}

function addEmployment() {
    const container = document.getElementById('employmentContainer');
    const newItem = container.children[0].cloneNode(true);
    
    // Update field names and IDs
    const inputs = newItem.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        const name = input.name.replace(/_\d+$/, `_${employmentCount}`);
        input.name = name;
        input.value = '';
        if (input.id) {
            input.id = input.id.replace(/\d+$/, employmentCount);
        }
    });
    
    // Update checkbox label
    const checkbox = newItem.querySelector('.form-check-input');
    const label = newItem.querySelector('.form-check-label');
    if (checkbox && label) {
        checkbox.id = `employmentCurrent${employmentCount}`;
        label.setAttribute('for', `employmentCurrent${employmentCount}`);
    }
    
    container.appendChild(newItem);
    employmentCount++;
}

function removeEmployment(button) {
    const container = document.getElementById('employmentContainer');
    if (container.children.length > 1) {
        button.closest('.employment-item').remove();
    }
}

function addSkill() {
    const container = document.getElementById('skillsContainer');
    const newItem = container.children[0].cloneNode(true);
    
    // Update field names and clear values
    const inputs = newItem.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        const name = input.name.replace(/_\d+$/, `_${skillCount}`);
        input.name = name;
        input.value = '';
        
        // Set up event listeners for new fields
        if (input.type !== 'hidden') {
            input.addEventListener('blur', function() {
                if (this.value && this.value.trim().length > 2) {
                    analyzeField(this);
                }
            });
        }
    });
    
    // Clear any existing annotations from the cloned item
    const annotations = newItem.querySelectorAll('.ai-annotation');
    annotations.forEach(annotation => annotation.remove());
    
    container.appendChild(newItem);
    skillCount++;
}

function removeSkill(button) {
    const container = document.getElementById('skillsContainer');
    if (container.children.length > 1) {
        button.closest('.skill-experience-item').remove();
    }
}

// Resume upload simulation
document.getElementById('resumeFile').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        simulateResumeUpload();
    }
});

function simulateResumeUpload() {
    const progressContainer = document.getElementById('resumeProgressContainer');
    const progressFill = document.getElementById('resumeProgressFill');
    const progressText = document.getElementById('resumeProgressText');
    
    progressContainer.style.display = 'block';
    
    // Reset progress bar to 0
    progressFill.style.width = '0%';
    progressText.textContent = '0%';
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        progressFill.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                populateFromResume();
                progressContainer.style.display = 'none';
                document.getElementById('resumeSuccess').style.display = 'block';
            }, 500);
        }
    }, 200);
}

function populateFromResume() {
    // Simulate AI parsing results
    document.getElementById('firstName').value = 'Sarah';
    document.getElementById('lastName').value = 'Chen';
    document.getElementById('email').value = 'sarah.chen@mun.ca';
    document.getElementById('phone').value = '(709) 123-4567';
    document.getElementById('academicYear').value = 'junior';
    document.getElementById('program').value = 'Computer Science';
    
    // Don't auto-populate passwords for security reasons
    // Users must manually set their passwords
    
    // Trigger AI analysis for populated fields
    setTimeout(() => {
        document.querySelectorAll('input[value], select').forEach(field => {
            if (field.value) {
                analyzeField(field);
            }
        });
    }, 500);
}

// Student webpage scanning functionality
function scanStudentWebpage() {
    const urlInput = document.getElementById('profileWebpageUrl');
    const url = urlInput.value.trim();
    
    if (!url) {
        alert('Please enter a profile URL');
        return;
    }
    
    simulateStudentWebpageScan(url);
}

function simulateStudentWebpageScan(url) {
    const progressContainer = document.getElementById('webpageProfileProgressContainer');
    const progressFill = document.getElementById('webpageProfileProgressFill');
    const progressText = document.getElementById('webpageProfileProgressText');
    
    progressContainer.style.display = 'block';
    
    // Reset progress bar to 0
    progressFill.style.width = '0%';
    progressText.textContent = '0%';
    
    let progress = 0;
    const stages = [
        'Connecting to profile...',
        'Analyzing profile content...',
        'Extracting personal information...',
        'Processing skills and experience...',
        'Finalizing data extraction...'
    ];
    
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        
        progressFill.style.width = progress + '%';
        const stageIndex = Math.floor((progress / 100) * stages.length);
        progressText.textContent = stages[Math.min(stageIndex, stages.length - 1)];
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                // Call the API to extract data
                extractStudentWebpageData(url);
            }, 500);
        }
    }, 300);
}

function extractStudentWebpageData(url) {
    fetch('/api/content/scan-webpage/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            webpage_url: url,
            scan_type: 'student',
            csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            populateFromStudentWebpage(data.extracted_data, url);
            document.getElementById('webpageProfileProgressContainer').style.display = 'none';
            document.getElementById('webpageSuccess').style.display = 'block';
        } else {
            alert('Error scanning profile: ' + data.message);
            document.getElementById('webpageProfileProgressContainer').style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while scanning the profile. Please try again.');
        document.getElementById('webpageProfileProgressContainer').style.display = 'none';
    });
}

function populateFromStudentWebpage(data, originalUrl) {
    // Populate basic information
    if (data.first_name) {
        document.getElementById('firstName').value = data.first_name;
    }
    if (data.last_name) {
        document.getElementById('lastName').value = data.last_name;
    }
    if (data.email) {
        document.getElementById('email').value = data.email;
    }
    if (data.phone) {
        document.getElementById('phone').value = data.phone;
    }
    if (data.academic_year) {
        document.getElementById('academicYear').value = data.academic_year;
    }
    if (data.program) {
        document.getElementById('program').value = data.program;
    }
    
    // Store extracted data for later population of education, employment, and skills
    // (External links will be populated in Step 8 Documents & Links)
    window.extractedWebpageData = data;
    window.scannedProfileUrl = originalUrl;
}

// Document management functions
function addDocument() {
    const container = document.getElementById('documentsContainer');
    const newItem = container.children[0].cloneNode(true);
    
    // Update field names and clear values
    const inputs = newItem.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        const name = input.name.replace(/_\d+$/, `_${documentCount}`);
        input.name = name;
        input.value = '';
    });
    
    container.appendChild(newItem);
    documentCount++;
}

function removeDocument(button) {
    const container = document.getElementById('documentsContainer');
    if (container.children.length > 1) {
        button.closest('.document-item').remove();
    }
}

// Link management functions  
function addLink() {
    const container = document.getElementById('linksContainer');
    const newItem = container.children[0].cloneNode(true);
    
    // Update field names and clear values
    const inputs = newItem.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        const name = input.name.replace(/_\d+$/, `_${linkCount}`);
        input.name = name;
        input.value = '';
    });
    
    container.appendChild(newItem);
    linkCount++;
}

function removeLink(button) {
    const container = document.getElementById('linksContainer');
    if (container.children.length > 1) {
        button.closest('.link-item').remove();
    }
}

// Pre-populate documents and links from scanning
function populateDocumentsAndLinksFromScanning() {
    // If resume was uploaded, add it to documents
    const resumeFile = document.getElementById('resumeFile');
    if (resumeFile.files.length > 0) {
        const firstDocType = document.querySelector('select[name="document_type_0"]');
        const firstDocTitle = document.querySelector('input[name="document_title_0"]');
        const firstDocDescription = document.querySelector('textarea[name="document_description_0"]');
        
        if (firstDocType) firstDocType.value = 'resume';
        if (firstDocTitle) firstDocTitle.value = 'Uploaded Resume';
        if (firstDocDescription) firstDocDescription.value = 'Resume uploaded during registration process';
    }
    
    // If webpage was scanned, add it to links
    const profileUrl = window.scannedProfileUrl;
    if (profileUrl) {
        const firstLinkType = document.querySelector('select[name="link_type_0"]');
        const firstLinkTitle = document.querySelector('input[name="link_title_0"]');  
        const firstLinkUrl = document.querySelector('input[name="link_url_0"]');
        const firstLinkDescription = document.querySelector('textarea[name="link_description_0"]');
        
        // Determine link type from URL
        let linkType = 'other';
        let linkTitle = 'Scanned Profile';
        if (profileUrl.includes('linkedin.com')) {
            linkType = 'linkedin';
            linkTitle = 'LinkedIn Profile';
        } else if (profileUrl.includes('github.com')) {
            linkType = 'github'; 
            linkTitle = 'GitHub Profile';
        } else if (profileUrl.includes('portfolio') || profileUrl.includes('behance') || profileUrl.includes('dribbble')) {
            linkType = 'portfolio';
            linkTitle = 'Portfolio Website';
        }
        
        if (firstLinkType) firstLinkType.value = linkType;
        if (firstLinkTitle) firstLinkTitle.value = linkTitle;
        if (firstLinkUrl) firstLinkUrl.value = profileUrl;
        if (firstLinkDescription) firstLinkDescription.value = 'Profile scanned during registration process';
    }
}

// Form submission
function submitForm() {
    const form = document.getElementById('registrationForm');
    const formData = new FormData(form);
    
    // Set final step
    formData.set('current_step', '8');
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Creating Profile...';
    submitBtn.disabled = true;
    
    fetch('{% url "web:process_student_registration" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Show success message
            document.getElementById('formContent').innerHTML = `
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="display-1 text-success">‚úÖ</i>
                    </div>
                    <h3 class="text-success mb-3">Profile Created Successfully!</h3>
                    <p class="mb-4">${data.message}</p>
                    <div class="spinner-border text-primary me-2" role="status"></div>
                    <span>Redirecting to your dashboard...</span>
                </div>
            `;
            
            // Hide navigation buttons
            document.querySelector('.d-flex.justify-content-between').style.display = 'none';
            
            // Redirect after delay
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 2000);
        } else {
            alert('Error: ' + data.message);
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating your profile. Please try again.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// Demo mode function for Step 1
function fillDemoProfileUrl() {
    // Fill the profile URL with a demo LinkedIn profile
    const profileUrlField = document.getElementById('profileWebpageUrl');
    if (profileUrlField) {
        profileUrlField.value = 'https://linkedin.com/in/sarah-chen';
        
        // Show brief feedback
        showDemoModeActivated('Profile URL filled with demo LinkedIn profile');
    }
}

// Demo mode function for Step 5 (Skills)
function fillDemoSkills() {
    // Fill the first skill field
    const skillNameField = document.querySelector('input[name="skill_name_0"]');
    const skillDescField = document.querySelector('textarea[name="skill_description_0"]');
    const skillLevelField = document.querySelector('select[name="skill_level_0"]');
    
    if (skillNameField && skillDescField && skillLevelField) {
        skillNameField.value = 'Python';
        skillDescField.value = 'Python web development';
        skillLevelField.value = 'intermediate';
    }
}

function showDemoModeActivated(message = 'Demo Mode Activated!') {
    // Create temporary notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="bi bi-info-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateNavigationButtons();
    
    // Add Enter key support for profile URL
    document.getElementById('profileWebpageUrl').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            scanStudentWebpage();
        }
    });
    
    // Demo mode key combination (Ctrl+Shift+D) - works on different steps
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            if (currentStep === 1) {
                fillDemoProfileUrl();
            } else if (currentStep === 5) {
                fillDemoSkills();
            }
        }
    });
});
</script>
{% endblock %}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            